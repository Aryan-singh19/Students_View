<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theory of Computation - Course 4.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f0f0f;
            --bg-panel: #1e1e1e;
            --bg-hover: #303030;
            --text-main: #ffffff;
            --text-mute: #aaaaaa;
            --brand: #ff0000;
            --success: #2ba640;
            --border: #333;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; overflow-x: hidden; transition: background 0.3s; }
        
        /* FOCUS MODE */
        body.focus-mode header, body.focus-mode .sidebar, body.focus-mode .info-area { opacity: 0.1; pointer-events: none; transition: opacity 0.5s; }
        body.focus-mode .player-wrapper { z-index: 200; transform: scale(1.02); transition: transform 0.5s; box-shadow: 0 0 50px rgba(0,0,0,0.8); }

        /* HEADER */
        header {
            background: rgba(15, 15, 15, 0.98);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border);
        }
        .logo { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 1.2rem; letter-spacing: -0.5px; }
        .logo svg { height: 24px; fill: var(--brand); }
        .controls-top { display: flex; gap: 10px; }
        .btn-sm { background: #333; color: #fff; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .btn-sm:hover { background: #444; }

        /* LAYOUT */
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 24px;
            padding: 24px;
            max-width: 1800px;
            margin: 0 auto;
            height: calc(100vh - 60px);
        }

        /* VIDEO PLAYER */
        .main-col { display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; }
        .player-wrapper {
            position: relative;
            padding-bottom: 56.25%;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            transition: all 0.3s;
        }
        .player-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* OVERLAYS */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .btn {
            background: #3ea6ff; color: #0f0f0f; border: none; padding: 10px 24px;
            font-weight: 600; border-radius: 2px; cursor: pointer; text-transform: uppercase;
        }
        .btn:hover { background: #65b8ff; }

        /* INFO AREA */
        .info-area { margin-top: 16px; border-bottom: 1px solid var(--border); padding-bottom: 16px; }
        h1.video-title { font-size: 1.25rem; margin: 0 0 8px 0; font-weight: 600; }
        .video-stats { display: flex; justify-content: space-between; color: var(--text-mute); font-size: 0.9rem; align-items: center; }

        /* TABS */
        .tabs { display: flex; gap: 20px; margin-top: 16px; border-bottom: 1px solid var(--border); }
        .tab {
            background: none; border: none; color: var(--text-mute);
            font-size: 1rem; font-weight: 500; padding: 0 0 10px 0;
            cursor: pointer; position: relative;
        }
        .tab.active { color: var(--text-main); }
        .tab.active::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: var(--text-main); border-radius: 3px 3px 0 0;
        }

        /* PANELS */
        .panel { display: none; margin-top: 20px; background: var(--bg-panel); padding: 20px; border-radius: 12px; }
        .panel.show { display: block; }
        
        /* NOTE SYSTEM */
        .note-input-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .note-input { flex: 1; padding: 10px; background: #111; border: 1px solid #333; color: white; border-radius: 4px; }
        .note-list { max-height: 400px; overflow-y: auto; }
        .note-item { 
            background: #222; padding: 10px; margin-bottom: 8px; border-radius: 4px; 
            border-left: 3px solid var(--brand); display: flex; justify-content: space-between; 
            animation: fadeIn 0.3s ease;
        }
        .note-time { color: var(--brand); font-weight: bold; cursor: pointer; margin-right: 10px; }
        .note-time:hover { text-decoration: underline; }

        /* ANALYTICS */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .stat-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; text-align: center; }
        .big-num { font-size: 2.5rem; font-weight: 700; color: var(--brand); }
        .download-btn {
            background: var(--bg-hover); color: var(--text-main);
            width: 100%; padding: 15px; border: 1px solid var(--border);
            border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            font-size: 1rem; font-weight: 600;
        }
        .download-btn:hover { background: #444; }

        /* SIDEBAR PLAYLIST */
        .sidebar {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex; flex-direction: column;
            overflow: hidden;
            height: 100%;
        }
        .playlist-head { padding: 16px; border-bottom: 1px solid var(--border); font-weight: 700; display: flex; justify-content: space-between; }
        .playlist-scroll { overflow-y: auto; flex: 1; }
        
        .playlist-item {
            display: flex; gap: 10px; padding: 10px; cursor: pointer;
            border-bottom: 1px solid transparent; transition: background 0.2s;
        }
        .playlist-item:hover { background: var(--bg-hover); }
        .playlist-item.active { background: #303030; border-left: 4px solid var(--brand); }

        .thumb {
            width: 100px; height: 56px; background: #000; border-radius: 8px; 
            position: relative; display: flex; align-items: center; justify-content: center;
            overflow: hidden; flex-shrink: 0;
        }
        .thumb-txt { color: #555; font-size: 1.5rem; }
        .progress-overlay {
            position: absolute; bottom: 0; left: 0; height: 4px; background: var(--brand); width: 0%;
        }
        .completed .progress-overlay { background: var(--success); }

        .meta { display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        .meta-title { font-size: 0.9rem; font-weight: 500; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .meta-sub { font-size: 0.75rem; color: var(--text-mute); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Responsive */
        @media(max-width: 1000px) {
            .grid-container { grid-template-columns: 1fr; height: auto; }
            .sidebar { height: 500px; }
        }
    </style>
</head>
<body>

<header>
    <div class="logo">
        <svg viewBox="0 0 24 24"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/></svg>
        CourseTube 4.0
    </div>
    <div class="controls-top">
        <button class="btn-sm" onclick="toggleFocus()">üåô Focus</button>
        <button class="btn-sm" onclick="changeSpeed(1.25)">1.25x</button>
        <button class="btn-sm" onclick="changeSpeed(1.5)">1.5x</button>
        <button class="btn-sm" onclick="changeSpeed(2.0)">2.0x</button>
    </div>
</header>

<div class="grid-container">
    
    <!-- LEFT: Player & Analytics -->
    <div class="main-col">
        
        <div class="player-wrapper">
            <div id="player"></div>
            <!-- Anti-Cheat Overlay -->
            <div class="overlay" id="cheat-screen">
                <h2 style="color:var(--brand)">‚ö†Ô∏è Playback Paused</h2>
                <p style="color:#ddd; margin-bottom: 20px;">Window focus lost. Please stay on this tab.</p>
                <button class="btn" onclick="resume()">Resume Playback</button>
            </div>
        </div>

        <div class="info-area">
            <h1 class="video-title" id="main-title">Loading Course...</h1>
            <div class="video-stats">
                <span id="video-count-display">Video 1 / 19</span>
                <span id="main-percent" style="color: var(--brand); font-weight:bold;">0% Watched</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="setTab('desc')">Overview</button>
            <button class="tab" onclick="setTab('notes')">üìù Notes</button>
            <button class="tab" onclick="setTab('analytics')">üìä Report</button>
        </div>

        <!-- Tab 1: Overview -->
        <div id="tab-desc" class="panel show">
            <p style="color:var(--text-mute); line-height: 1.6;">
                <b>Theory of Computation</b><br>
                This intelligent tracker monitors your watch progress, lets you take timestamped notes, and verifies your completion.
            </p>
            <p style="color: #666; font-size: 0.9rem;">
                <i>Tip: Use the Speed buttons in the top right for faster review.</i>
            </p>
        </div>

        <!-- Tab 2: Notes -->
        <div id="tab-notes" class="panel">
            <div class="note-input-row">
                <input type="text" id="note-input" class="note-input" placeholder="Type note here (e.g. 'Turing Machine Definition')...">
                <button class="btn" style="padding: 10px 15px;" onclick="addNote()">+ Add Note</button>
            </div>
            <div id="notes-list" class="note-list">
                <!-- Notes injected here -->
            </div>
        </div>

        <!-- Tab 3: Analytics -->
        <div id="tab-analytics" class="panel">
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="big-num" id="total-stat">0%</div>
                    <div style="color:var(--text-mute); font-size:0.8rem;">COURSE COMPLETION</div>
                </div>
                <div class="stat-card">
                    <div class="big-num" id="watched-stat">0</div>
                    <div style="color:var(--text-mute); font-size:0.8rem;">VIDEOS FINISHED</div>
                </div>
            </div>
            
            <button class="download-btn" onclick="downloadReport()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                Download Verified Report (.txt)
            </button>
            <div style="text-align: center; margin-top: 10px; color: #555; font-size: 0.8rem;">
                Report includes a cryptographic hash to prevent tampering.
            </div>
        </div>

    </div>

    <!-- RIGHT: Playlist -->
    <div class="sidebar">
        <div class="playlist-head">
            <span>Course Content</span>
            <span style="color:var(--text-mute); font-weight:400;">19 Videos</span>
        </div>
        <div class="playlist-scroll" id="playlist-container">
            <!-- Items injected via JS -->
        </div>
    </div>

</div>

<script>
    // --- CONFIG ---
    const PLAYLIST_ID = 'PL424dCM7s48ngY-ylr6rKDhZC-eojZyOT';
    const STORAGE_KEY = 'toc_tracker_v4';
    const NOTES_KEY = 'toc_notes_v4';

    const VIDEOS = [
        "01 Intro to Grammar & Recursively Enumerable", "02 Language Generated by Grammar (Ex 1)",
        "03 Language Generated by Grammar (Ex 2)", "04 Language Generated by Grammar (Ex 3)",
        "05 RLG to LLG 1", "06 LLG to RLG", "07 Elimination of Useless Symbols (TOC)",
        "08 Context Free Grammar", "09 Push Down Automata", "10 Practice Questions PDA and NPDA",
        "11 Conversion of CFG to PDA", "12 Turing Machine", "13 Turing Machine: Practice Questions",
        "14 Intro to Recursively Enumerable Sets", "15 Undecidability & Comp. Classes",
        "16 Universal Turing Machine", "17 Computational Classes", "18 Sequence Detector (Moore & Mealy)",
        "19 Master PDA to CFG Conversion"
    ];

    // --- STATE ---
    var player, timer;
    var currentIndex = -1;
    var currentDuration = 0;
    var progress = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
    var notes = JSON.parse(localStorage.getItem(NOTES_KEY)) || {};

    // --- SETUP ---
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '100%', width: '100%',
            playerVars: { listType: 'playlist', list: PLAYLIST_ID, rel: 0, modestbranding: 1 },
            events: { 'onReady': initApp, 'onStateChange': onStateChange }
        });
    }

    function initApp() {
        renderSidebar();
        updateAnalytics();
    }

    function onStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
            detectVideoChange();
            startTracking();
            document.getElementById('cheat-screen').style.display = 'none';
        } else if (event.data == YT.PlayerState.CUED) {
            renderSidebar();
        } else {
            stopTracking();
        }
    }

    // --- TRACKING ---
    function detectVideoChange() {
        let idx = player.getPlaylistIndex();
        
        // Update Active Sidebar Item
        document.querySelectorAll('.playlist-item').forEach(e => e.classList.remove('active'));
        let activeEl = document.getElementById(`item-${idx}`);
        if(activeEl) {
            activeEl.classList.add('active');
            activeEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        if (idx !== currentIndex || currentDuration === 0) {
            currentIndex = idx;
            currentDuration = Math.floor(player.getDuration());
            
            if (!progress[currentIndex]) progress[currentIndex] = new Array(currentDuration).fill(0);
            else if (progress[currentIndex].length < currentDuration) {
                let old = progress[currentIndex];
                progress[currentIndex] = new Array(currentDuration).fill(0);
                for(let i=0; i<old.length; i++) progress[currentIndex][i] = old[i];
            }
            updateMainInfo();
            renderNotes(); // Load notes for this video
        }
    }

    function startTracking() {
        clearInterval(timer);
        timer = setInterval(() => {
            let t = Math.floor(player.getCurrentTime());
            if (progress[currentIndex] && t < progress[currentIndex].length) {
                progress[currentIndex][t] = 1;
                if (t % 2 === 0) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
                    updateUIRealTime();
                }
            }
        }, 1000);
    }

    function stopTracking() {
        clearInterval(timer);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
        updateAnalytics();
    }

    // --- UI FUNCTIONS ---
    function renderSidebar() {
        const list = document.getElementById('playlist-container');
        list.innerHTML = '';
        VIDEOS.forEach((title, i) => {
            let el = document.createElement('div');
            el.className = 'playlist-item';
            el.id = `item-${i}`;
            el.onclick = () => player.playVideoAt(i);
            let pct = getPct(i);
            el.innerHTML = `
                <div class="thumb ${pct>95?'completed':''}">
                    <span class="thumb-txt">‚ñ∂</span>
                    <div class="progress-overlay" style="width:${pct}%" id="bar-${i}"></div>
                </div>
                <div class="meta">
                    <div class="meta-title">${i+1}. ${title}</div>
                    <div class="meta-sub" id="sub-${i}">${pct}% Watched</div>
                </div>
            `;
            list.appendChild(el);
        });
    }

    function updateMainInfo() {
        let title = VIDEOS[currentIndex] || `Video ${currentIndex+1}`;
        document.getElementById('main-title').innerText = title;
        document.getElementById('video-count-display').innerText = `Video ${currentIndex + 1} of ${VIDEOS.length}`;
    }

    function updateUIRealTime() {
        let pct = getPct(currentIndex);
        document.getElementById('main-percent').innerText = `${pct}% Watched`;
        let bar = document.getElementById(`bar-${currentIndex}`);
        let sub = document.getElementById(`sub-${currentIndex}`);
        if(bar) bar.style.width = `${pct}%`;
        if(sub) sub.innerText = `${pct}% Watched`;
    }

    function updateAnalytics() {
        let totalSum = 0;
        let completedCount = 0;
        VIDEOS.forEach((_, i) => {
            let p = parseFloat(getPct(i));
            totalSum += p;
            if(p > 95) completedCount++;
        });
        document.getElementById('total-stat').innerText = `${(totalSum / VIDEOS.length).toFixed(1)}%`;
        document.getElementById('watched-stat').innerText = `${completedCount} / ${VIDEOS.length}`;
    }

    function getPct(i) {
        if(!progress[i]) return 0;
        let watched = progress[i].filter(x => x===1).length;
        let total = progress[i].length;
        return total === 0 ? 0 : ((watched/total)*100).toFixed(0);
    }

    // --- NOTES SYSTEM ---
    function addNote() {
        let input = document.getElementById('note-input');
        let text = input.value.trim();
        if (!text || currentIndex === -1) return;
        
        let time = Math.floor(player.getCurrentTime());
        if (!notes[currentIndex]) notes[currentIndex] = [];
        notes[currentIndex].push({ time: time, text: text });
        notes[currentIndex].sort((a,b) => a.time - b.time); // Keep sorted
        
        localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
        input.value = '';
        renderNotes();
    }

    function renderNotes() {
        const list = document.getElementById('notes-list');
        list.innerHTML = '';
        let vidNotes = notes[currentIndex] || [];
        
        if (vidNotes.length === 0) {
            list.innerHTML = '<div style="color:#666; padding:10px;">No notes for this video yet.</div>';
            return;
        }

        vidNotes.forEach((n, i) => {
            let div = document.createElement('div');
            div.className = 'note-item';
            div.innerHTML = `
                <div>
                    <span class="note-time" onclick="player.seekTo(${n.time})">${formatTime(n.time)}</span>
                    <span>${n.text}</span>
                </div>
                <button onclick="deleteNote(${i})" style="background:none; border:none; color:#666; cursor:pointer;">‚úï</button>
            `;
            list.appendChild(div);
        });
    }

    function deleteNote(i) {
        if(confirm("Delete note?")) {
            notes[currentIndex].splice(i, 1);
            localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
            renderNotes();
        }
    }

    function formatTime(s) {
        let m = Math.floor(s / 60);
        let sec = s % 60;
        return `${m}:${sec < 10 ? '0' : ''}${sec}`;
    }

    // --- EXTRAS ---
    window.setTab = function(t) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('show'));
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${t}`).classList.add('show');
        event.target.classList.add('active');
    }

    window.resume = function() {
        document.getElementById('cheat-screen').style.display = 'none';
        player.playVideo();
    }

    window.toggleFocus = function() {
        document.body.classList.toggle('focus-mode');
    }

    window.changeSpeed = function(rate) {
        if(player) player.setPlaybackRate(rate);
    }

    // --- SECURE REPORT GEN ---
    window.downloadReport = function() {
        let total = document.getElementById('total-stat').innerText;
        let txt = "COURSE 4.0 VERIFIED REPORT\n";
        txt += "--------------------------\n";
        txt += `Date: ${new Date().toLocaleString()}\n`;
        txt += `Total Score: ${total}\n\n`;
        
        let hashSource = total;
        VIDEOS.forEach((title, i) => {
            let p = getPct(i);
            txt += `${p > 95 ? '[X]' : '[ ]'} ${p}% | ${title}\n`;
            hashSource += `:${p}`;
        });
        
        // Simple Hash for Anti-Fraud
        let hash = 0;
        for (let i = 0; i < hashSource.length; i++) {
            hash = ((hash << 5) - hash) + hashSource.charCodeAt(i);
            hash |= 0;
        }
        
        txt += `\n[VERIFICATION CODE: ${Math.abs(hash).toString(16).toUpperCase()}]\n`;
        txt += "Do not modify this file. The code above verifies authenticity.";

        let blob = new Blob([txt], { type: "text/plain" });
        let a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "TOC_Verified_Report.txt";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    document.addEventListener("visibilitychange", function() {
        if (document.hidden && player && player.getPlayerState() === 1) {
            player.pauseVideo();
            document.getElementById('cheat-screen').style.display = 'flex';
        }
    });

</script>

</body>
</html>

          
