<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics | Theory of Computation Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0e11; --card: #15191c; --text: #f8f9fa;
            --accent: #ff0000; --border: #2d3339; --success: #00c853; 
            --warning: #ffd600; --danger: #ff1744;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 30px; margin: 0; line-height: 1.6; }
        
        /* AUTH OVERLAY */
        #auth-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .login-card { background: var(--card); padding: 40px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 40px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .header h1 { margin: 0; font-size: 2rem; font-weight: 700; letter-spacing: -1px; }
        .header p { margin: 5px 0 0 0; color: #888; font-size: 0.9rem; }

        /* KPI CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: var(--card); padding: 25px; border-radius: 16px; border: 1px solid var(--border); transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); border-color: var(--accent); }
        .stat-val { font-size: 2.5rem; font-weight: 700; color: var(--accent); display: block; }
        .stat-label { font-size: 0.75rem; color: #888; text-transform: uppercase; font-weight: 600; letter-spacing: 1.5px; }

        /* TABLE STYLING */
        .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .table-wrapper { background: var(--card); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th { background: #1c2126; padding: 20px; font-size: 0.75rem; color: #5c636a; text-transform: uppercase; font-weight: 700; }
        td { padding: 20px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        tr:last-child td { border-bottom: none; }
        
        .name-tag { font-weight: 600; color: #fff; display: block; }
        .email-tag { font-size: 0.75rem; color: #5c636a; }
        
        .prog-container { display: flex; align-items: center; gap: 15px; }
        .prog-track { flex: 1; height: 6px; background: #2d3339; border-radius: 10px; overflow: hidden; }
        .prog-bar { height: 100%; background: linear-gradient(90deg, #ff0000, #ff4e4e); border-radius: 10px; }
        
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .badge-google { background: rgba(66, 133, 244, 0.1); color: #4285f4; }
        .badge-guest { background: rgba(255, 255, 255, 0.05); color: #888; }

        /* RECOVERY MODAL STYLES */
        #merge-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:10000; align-items:center; justify-content:center; }
        .m-box { background:var(--card); padding:30px; border-radius:20px; width:450px; border:1px solid var(--border); box-shadow: 0 20px 50px black; }
        select { width:100%; padding:12px; background:#111; color:white; border:1px solid #333; margin:20px 0; border-radius:8px; font-size:1rem; }

        /* CHAT MANAGEMENT */
        .chat-mgmt { background: var(--card); border-radius: 16px; border: 1px solid var(--border); padding: 25px; }
        .chat-scroll { max-height: 400px; overflow-y: auto; background: #0b0e11; border-radius: 12px; padding: 10px; border: 1px solid #1c2126; }
        .chat-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #1c2126; font-size: 0.85rem; }
        .chat-row:last-child { border-bottom: none; }
        .btn-del { color: var(--danger); cursor: pointer; font-weight: 600; font-size: 0.75rem; padding: 5px 10px; border-radius: 4px; }
        .btn-del:hover { background: rgba(255, 23, 68, 0.1); }

        /* BUTTONS */
        .btn { padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; border: 1px solid var(--border); font-size: 0.85rem; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .btn-csv { background: var(--success); color: white; border: none; }
        .btn-csv:hover { background: #00a946; box-shadow: 0 0 15px rgba(0,200,83,0.3); }
        .btn-clear { background: transparent; color: var(--danger); border-color: var(--danger); }
        .btn-clear:hover { background: var(--danger); color: white; }
        .btn-fix { background: var(--success); color: white; padding: 6px 12px; font-size: 0.7rem; border: none; }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="login-card">
        <h2 style="margin:0 0 10px 0;">Administrative Portal</h2>
        <p style="color:#888; margin-bottom:30px;">Authorized Access Only â€¢ TOC CourseTube</p>
        <button class="btn btn-csv" onclick="loginAdmin()" style="width:100%; justify-content:center; padding:15px;">Login with Google</button>
        <p id="auth-error" style="color:var(--danger); font-size:0.8rem; margin-top:15px;"></p>
    </div>
</div>

<div id="merge-modal">
    <div class="m-box">
        <h2 style="margin:0; color:var(--success);">Data Recovery</h2>
        <p id="guest-info" style="color:#aaa; font-size:0.9rem; margin:10px 0;"></p>
        <label style="font-size:0.8rem; color:#888;">TARGET VERIFIED ACCOUNT:</label>
        <select id="google-picker"></select>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-csv" style="flex:2; justify-content:center;" onclick="executeManualMerge()">Transfer Data</button>
            <button class="btn" style="background:#444; color:white; flex:1; justify-content:center;" onclick="document.getElementById('merge-modal').style.display='none'">Cancel</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="header">
        <div>
            <h1>Student Analytics</h1>
            <p>Real-time performance monitoring & class management</p>
        </div>
        <div class="btn-group">
            <button class="btn btn-csv" onclick="downloadCSV()">ðŸ“¥ Export Sheet</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-label">Enrollment</span>
            <span class="stat-val" id="total-students">0</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Class Average</span>
            <span class="stat-val" id="avg-completion">0%</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Top Scorer</span>
            <span class="stat-val" id="top-performer" style="font-size:1.5rem; margin-top:10px;">---</span>
        </div>
    </div>

    <div class="section-title">ðŸ“Š Individual Progress Tracker</div>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Student Details</th>
                    <th>Authentication</th>
                    <th>Curriculum Progress</th>
                    <th>Last Active</th>
                </tr>
            </thead>
            <tbody id="data-table">
                <tr><td colspan="4" style="text-align:center; padding:60px; color:#5c636a;">Initializing Secure Connection...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="chat-mgmt">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div class="section-title" style="margin:0;">ðŸ’¬ Chat Moderation</div>
            <button class="btn btn-clear" onclick="clearAllChat()">Wipe Chat History</button>
        </div>
        <div class="chat-scroll" id="admin-chat-list"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, signInWithPopup, signInWithRedirect, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, collection, doc, query, orderBy, onSnapshot, deleteDoc, getDocs, writeBatch, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyByqcto5JMr3BWJyemb9Q2XLi8OSBRfaTw",
      authDomain: "students-view.firebaseapp.com",
      projectId: "students-view",
      storageBucket: "students-view.firebasestorage.app",
      messagingSenderId: "969909965594",
      appId: "1:969909965594:web:931863f8899c7f28b1d2a3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    const TOTAL_VIDEOS = 19;
    let rawStudentDocs = [];
    let pendingGuestId = null;

    window.loginAdmin = async () => {
        try { await signInWithPopup(auth, provider); } 
        catch (e) { await signInWithRedirect(auth, provider); }
    };

    onAuthStateChanged(auth, (user) => {
        const admins = ["aryansingh19gh@gmail.com", "sir-email@gmail.com"];
        if (user && admins.includes(user.email)) {
            document.getElementById('auth-overlay').style.display = 'none';
            initDashboard();
        } else if (user) {
            document.getElementById('auth-error').innerText = "Access Denied: " + user.email + " is not an authorized administrator.";
            setTimeout(() => auth.signOut(), 4000);
        }
    });

    function initDashboard() {
        onSnapshot(collection(db, "user_progress"), (snapshot) => {
            const tbody = document.getElementById('data-table');
            const picker = document.getElementById('google-picker');
            tbody.innerHTML = ''; 
            picker.innerHTML = '<option value="">-- Choose Target Account --</option>';
            rawStudentDocs = [];
            
            let totalPctSum = 0; let count = 0; let topName = "---"; let topPct = -1;

            snapshot.forEach((d) => {
                const data = { ...d.data(), id: d.id };
                rawStudentDocs.push(data);
                if (!data.isGuest) {
                    const opt = document.createElement('option');
                    opt.value = data.id;
                    opt.innerText = `${data.name} (${data.email})`;
                    picker.appendChild(opt);
                }
            });

            rawStudentDocs.forEach((data) => {
                const progress = data.progress || {};
                let videoSums = 0;
                for(let i=0; i<TOTAL_VIDEOS; i++) {
                    if(progress[i]) {
                        const watched = progress[i].filter(x => x === 1).length;
                        videoSums += (watched / progress[i].length) * 100;
                    }
                }
                const avgPct = parseFloat((videoSums / TOTAL_VIDEOS).toFixed(1));
                totalPctSum += avgPct; count++;
                if(avgPct > topPct) { topPct = avgPct; topName = data.name || "Anonymous"; }
                
                const timeStr = data.lastUpdated ? new Date(data.lastUpdated.seconds * 1000).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }) : '---';

                tbody.innerHTML += `
                    <tr>
                        <td>
                            <span class="name-tag">${data.name || 'Unknown'}</span>
                            <span class="email-tag">${data.email || 'Guest Session'}</span>
                        </td>
                        <td><span class="badge ${data.isGuest ? 'badge-guest' : 'badge-google'}">${data.isGuest ? 'Guest' : 'Verified Google'}</span></td>
                        <td>
                            <div class="prog-container">
                                <div class="prog-track"><div class="prog-bar" style="width:${avgPct}%"></div></div>
                                <span style="font-weight:600; width:45px;">${avgPct}%</span>
                            </div>
                        </td>
                        <td>
                            ${data.isGuest ? `<button class="btn btn-fix" onclick="openMergeModal('${data.id}', '${data.name}')">Fix</button>` : ''}
                            <span class="btn-del" onclick="deleteUserRecord('${data.id}')">Delete</span>
                        </td>
                    </tr>`;
            });
            document.getElementById('total-students').innerText = count;
            document.getElementById('avg-completion').innerText = count > 0 ? (totalPctSum / count).toFixed(1) + "%" : "0%";
            document.getElementById('top-performer').innerText = topName;
        });

        onSnapshot(query(collection(db, "chat_messages"), orderBy("createdAt", "desc")), (snap) => {
            const chatList = document.getElementById('admin-chat-list');
            chatList.innerHTML = '';
            snap.forEach((msgDoc) => {
                const m = msgDoc.data();
                const div = document.createElement('div');
                div.className = 'chat-row';
                div.innerHTML = `<span><b style="color:var(--accent)">${m.user}:</b> ${m.text}</span>
                                 <span class="btn-del" onclick="deleteMsg('${msgDoc.id}')">Remove</span>`;
                chatList.appendChild(div);
            });
        });
    }

    // MANUAL MERGE HANDLERS
    window.openMergeModal = (id, name) => {
        pendingGuestId = id;
        document.getElementById('guest-info').innerText = `Merge progress for "${name}" into a Google Account?`;
        document.getElementById('merge-modal').style.display = 'flex';
    };

    window.executeManualMerge = async () => {
        const targetGoogleId = document.getElementById('google-picker').value;
        if (!targetGoogleId) return alert("Select a target Google account!");

        const guestDoc = rawStudentDocs.find(d => d.id === pendingGuestId);
        const googleDoc = rawStudentDocs.find(d => d.id === targetGoogleId);

        if (guestDoc && googleDoc) {
            let mergedProgress = { ...googleDoc.progress };
            for (let key in guestDoc.progress) {
                if (!mergedProgress[key]) mergedProgress[key] = guestDoc.progress[key];
                else {
                    for (let i = 0; i < guestDoc.progress[key].length; i++) {
                        if (guestDoc.progress[key][i] === 1) mergedProgress[key][i] = 1;
                    }
                }
            }
            try {
                await updateDoc(doc(db, "user_progress", targetGoogleId), { progress: mergedProgress });
                await deleteDoc(doc(db, "user_progress", pendingGuestId));
                document.getElementById('merge-modal').style.display = 'none';
                alert("Data Successfully Restored!");
            } catch (e) { alert("Merge failed: " + e.message); }
        }
    };

    window.deleteUserRecord = async (id) => { if(confirm("Delete this student data?")) await deleteDoc(doc(db, "user_progress", id)); };
    window.deleteMsg = async (id) => { if(confirm("Permanently delete message?")) await deleteDoc(doc(db, "chat_messages", id)); };
    
    window.clearAllChat = async () => {
        if(confirm("Wipe chat history?")) {
            const batch = writeBatch(db);
            const snap = await getDocs(collection(db, "chat_messages"));
            snap.forEach(d => batch.delete(d.ref));
            await batch.commit();
        }
    };

    window.downloadCSV = () => {
        let csv = "Student Name,Email,Completion %,Last Active\n";
        rawStudentDocs.forEach(r => {
            let videoSums = 0;
            for(let i=0; i<TOTAL_VIDEOS; i++) {
                if(r.progress && r.progress[i]) {
                    const watched = r.progress[i].filter(x => x === 1).length;
                    videoSums += (watched / r.progress[i].length) * 100;
                }
            }
            const p = (videoSums / TOTAL_VIDEOS).toFixed(1);
            csv += `"${r.name}","${r.email || 'Guest'}",${p}%,"${r.lastUpdated}"\n`;
        });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
        link.download = `TOC_Class_Report.csv`; link.click();
    };
</script>
</body>
</html>
