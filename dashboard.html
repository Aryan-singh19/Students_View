<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CourseTube Admin - Student Analytics</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f0f0f; --panel: #1e1e1e; --text: #ffffff;
            --brand: #ff0000; --border: #333; --success: #2ba640; --danger: #cc0000;
        }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text); padding: 40px; margin: 0; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .btn-group { display: flex; gap: 10px; }
        .btn { padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; border: 1px solid var(--border); transition: 0.2s; font-size: 0.85rem; }
        .btn-refresh { background: #333; color: white; }
        .btn-download { background: var(--success); color: white; border: none; }
        .btn-danger { background: var(--danger); color: white; border: none; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--panel); padding: 25px; border-radius: 12px; border: 1px solid var(--border); }
        .stat-val { font-size: 2.2rem; font-weight: 700; color: var(--brand); margin-bottom: 5px; }
        .stat-label { font-size: 0.85rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
        .table-container { background: var(--panel); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 40px; }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th { background: #252525; padding: 18px; font-size: 0.8rem; color: #888; text-transform: uppercase; }
        td { padding: 18px; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        .prog-wrapper { display: flex; align-items: center; gap: 12px; }
        .prog-bg { flex: 1; height: 10px; background: #333; border-radius: 10px; overflow: hidden; max-width: 150px; }
        .prog-fill { height: 100%; background: linear-gradient(90deg, #ff0000, #ff4d4d); transition: width 0.5s ease; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; }
        .badge-google { background: rgba(66, 133, 244, 0.15); color: #4285f4; }
        .badge-guest { background: rgba(255, 255, 255, 0.05); color: #aaa; }
        .chat-mgmt { background: var(--panel); border-radius: 12px; border: 1px solid var(--border); padding: 25px; }
        .chat-list { max-height: 400px; overflow-y: auto; background: #111; padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
        .chat-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #222; }
        .del-link { color: var(--danger); cursor: pointer; font-size: 0.8rem; font-weight: bold; }
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="auth-overlay">
    <h2 style="color:white;">Admin Dashboard Locked</h2>
    <p style="color:#666;">Login with your authorized Gmail to access data.</p>
    <button class="btn btn-download" onclick="loginAdmin()">Login with Google</button>
</div>

<div class="header">
    <div>
        <h1 style="margin:0;">Student Progress Sheet</h1>
        <p style="color:#666; margin:5px 0 0 0;">Unified Student Records & Class Management.</p>
    </div>
    <div class="btn-group">
        <button class="btn btn-refresh" onclick="location.reload()">üîÑ Refresh</button>
        <button class="btn btn-download" onclick="downloadCSV()">üì• Download CSV</button>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card"><div class="stat-val" id="total-students">0</div><div class="stat-label">Total Enrolled</div></div>
    <div class="stat-card"><div class="stat-val" id="avg-completion">0%</div><div class="stat-label">Class Average</div></div>
    <div class="stat-card"><div class="stat-val" id="top-performer">N/A</div><div class="stat-label">Top Performer</div></div>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr><th>Student</th><th>Login Type</th><th>Overall Progress</th><th>Last Update</th></tr>
        </thead>
        <tbody id="data-table">
            <tr><td colspan="4" style="text-align:center; padding:40px; color:#555;">Loading Firestore data...</td></tr>
        </tbody>
    </table>
</div>

<div class="chat-mgmt">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;">Live Chat Management</h2>
        <button class="btn btn-danger" onclick="clearAllChat()">‚ö†Ô∏è Wipe All History</button>
    </div>
    <div class="chat-list" id="admin-chat-list"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, signInWithRedirect, getRedirectResult, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, collection, doc, query, orderBy, onSnapshot, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyByqcto5JMr3BWJyemb9Q2XLi8OSBRfaTw",
      authDomain: "students-view.firebaseapp.com",
      projectId: "students-view",
      storageBucket: "students-view.firebasestorage.app",
      messagingSenderId: "969909965594",
      appId: "1:969909965594:web:931863f8899c7f28b1d2a3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    const TOTAL_VIDEOS = 19;
    let studentsRawData = [];

    window.loginAdmin = () => signInWithRedirect(auth, provider);

    onAuthStateChanged(auth, (user) => {
        if (user && user.email === "aryansingh19gh@gmail.com") {
            document.getElementById('auth-overlay').style.display = 'none';
            initDashboard();
        }
    });

    function initDashboard() {
        onSnapshot(collection(db, "user_progress"), (snapshot) => {
            const tbody = document.getElementById('data-table');
            tbody.innerHTML = '';
            studentsRawData = [];
            let totalPctSum = 0; let count = 0; let topName = "N/A"; let topPct = -1;

            snapshot.forEach((doc) => {
                const data = doc.data();
                const progress = data.progress || {};
                let videoSums = 0;
                for(let i=0; i<TOTAL_VIDEOS; i++) {
                    if(progress[i]) {
                        const watched = progress[i].filter(x => x === 1).length;
                        const total = progress[i].length;
                        videoSums += total === 0 ? 0 : (watched / total) * 100;
                    }
                }
                const avgPct = parseFloat((videoSums / TOTAL_VIDEOS).toFixed(1));
                totalPctSum += avgPct; count++;
                if(avgPct > topPct) { topPct = avgPct; topName = data.name || "Anonymous"; }
                const time = data.lastUpdated ? new Date(data.lastUpdated.seconds * 1000).toLocaleString() : '---';
                studentsRawData.push({ name: data.name, email: data.email, progress: avgPct, lastSeen: time });

                tbody.innerHTML += `<tr><td><b>${data.name || 'Unknown'}</b><br><small style="color:#666">${data.email || ''}</small></td>
                    <td><span class="badge ${data.isGuest ? 'badge-guest' : 'badge-google'}">${data.isGuest ? 'GUEST' : 'GOOGLE'}</span></td>
                    <td><div class="prog-wrapper"><div class="prog-bg"><div class="prog-fill" style="width:${avgPct}%"></div></div><span>${avgPct}%</span></div></td>
                    <td style="font-size:0.8rem; color:#666;">${time}</td></tr>`;
            });
            document.getElementById('total-students').innerText = count;
            document.getElementById('avg-completion').innerText = count > 0 ? (totalPctSum / count).toFixed(1) + "%" : "0%";
            document.getElementById('top-performer').innerText = topName;
        });

        onSnapshot(query(collection(db, "chat_messages"), orderBy("createdAt", "desc")), (snap) => {
            const chatList = document.getElementById('admin-chat-list');
            chatList.innerHTML = '';
            snap.forEach((msgDoc) => {
                const m = msgDoc.data();
                const div = document.createElement('div');
                div.className = 'chat-item';
                div.innerHTML = `<span><b>${m.user}:</b> ${m.text}</span><span class="del-link" onclick="deleteMsg('${msgDoc.id}')">DELETE</span>`;
                chatList.appendChild(div);
            });
        });
    }

    window.deleteMsg = async (id) => { if(confirm("Delete message?")) await deleteDoc(doc(db, "chat_messages", id)); };
    window.clearAllChat = async () => {
        if(confirm("Wipe chat?")) {
            const batch = writeBatch(db);
            const snap = await getDocs(collection(db, "chat_messages"));
            snap.forEach(d => batch.delete(d.ref));
            await batch.commit();
        }
    };
    window.downloadCSV = () => {
        let csv = "Student Name,Email,Completion %,Last Active\n";
        studentsRawData.forEach(r => csv += `"${r.name}","${r.email}",${r.progress}%,"${r.lastSeen}"\n`);
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' })); a.download = "Class_Report.csv"; a.click();
    };
</script>
</body>
        </html>
